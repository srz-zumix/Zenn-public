---
title: "Zenn ã®è¨˜äº‹ã‚’ private/public repository ã§åŒæœŸã™ã‚‹ GitHub Actions"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Zenn", "GitHub", "GitHubActions"]
published: true
---

## Zenn ã«ãŠã‘ã‚‹ GitHub é€£æº

Zenn ã¯ GitHub é€£æºã—ã¦è¨˜äº‹ç®¡ç†ã§ãã‚‹ä¾¿åˆ©ãªæ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚
ã€Œ[GitHubãƒªãƒã‚¸ãƒˆãƒªã§Zennã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç®¡ç†ã™ã‚‹](https://zenn.dev/zenn/articles/connect-to-github)ã€

ãŸã ã—ã€åŒæœŸã§ãã‚‹ãƒªãƒã‚¸ãƒˆãƒªã¯ï¼‘ã¤ã®ã¿ã®ãŸã‚

* ã€Œæœ‰æ–™ãªæœ¬ã¯ Private ãƒªãƒã‚¸ãƒˆãƒªã«ã—ãŸã„ã€
* ã€Œç„¡æ–™ã®è¨˜äº‹ã¯ Public ãƒªãƒã‚¸ãƒˆãƒªã«ã—ãŸã„ï¼ˆPR å—ã‘ä»˜ã‘ãŸã„ï¼‰ã€

ãã‚“ãªå ´åˆã«ã©ã£ã¡ã—ã‹å–ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚

**ãã“ã§ Private ãƒªãƒã‚¸ãƒˆãƒªã®ç„¡æ–™å…¬é–‹è¨˜äº‹ã‚’ Public ãƒªãƒã‚¸ãƒˆãƒªåŒæœŸã™ã‚‹ GitHub Action ã‚’æ›¸ã„ãŸã®ã§ç´¹ä»‹ã—ã¾ã™ã€‚**

## æ§‹æˆ

Zenn ã¨åŒæœŸã™ã‚‹ã®ã¯ Private ãƒªãƒã‚¸ãƒˆãƒªã§ã™ã€‚
Private ãƒªãƒã‚¸ãƒˆãƒªã§åŸ·ç­†ã—ã¾ã™ã€‚
Private ãƒªãƒã‚¸ãƒˆãƒªã®åŒæœŸãƒ–ãƒ©ãƒ³ãƒãŒæ›´æ–°ï¼ˆpushï¼‰ã•ã‚Œã‚‹ã¨ Priate ãƒªãƒã‚¸ãƒˆãƒªã§åŒæœŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
ï¼ˆPR ã®ã“ã¨ã‚‚è€ƒãˆã¦é€†æ–¹å‘ã‚‚å¯¾å¿œã—ã¦ã¾ã™ï¼‰

![æ§‹æˆ](https://storage.googleapis.com/zenn-user-upload/w6m791xu4bflotxuccl25v796s9d)

ä»¥ä¸‹ã§è©³ã—ãèª¬æ˜ã—ã¾ã™ã€‚

## ç„¡æ–™è¨˜äº‹ã‚’ Public ãƒªãƒã‚¸ãƒˆãƒªã«åŒæœŸã™ã‚‹

å®Ÿéš›ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ãŸã»ã†ãŒæ—©ã„ã¨æ€ã†ã®ã§ã€
YAML ã«ã‚³ãƒ¡ãƒ³ãƒˆè£œè¶³ã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ã§èª¬æ˜ã—ã¾ã™ã€‚
å®Ÿéš›ã®è¨­å®šã¯ã“ã¡ã‚‰ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚
https://github.com/srz-zumix/Zenn-public

### GitHub Action

https://github.com/srz-zumix/Zenn-public/blob/master/.github/workflows/sync.yml

```yaml:sync.yml
name: 'Run sync'
on:
  # å‹•ä½œç¢ºèªç”¨ã«ä½¿ã£ã¦ãŸãƒˆãƒªã‚¬ãƒ¼
  # pull_request:
  # Private ãƒªãƒã‚¸ãƒˆãƒª ã«æ›´æ–°ãŒã‚ã£ãŸå ´åˆã«ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹
  repository_dispatch:
    types: [sync]

jobs:
  sync-from-private:
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: 3.8
      # Private ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒªãƒã‚¸ãƒˆãƒªå
      FROM_REPO_USER: "srz-zumix"
      FROM_REPO_NAME: "Zenn"
    steps:
      # è‡ªåˆ†ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - uses: actions/checkout@v1
      # Private ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - uses: actions/checkout@v1
        with:
          repository: ${{ env.FROM_REPO_USER }}/${{ env.FROM_REPO_NAME }}
          # ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¯ `repo` ã‚’å«ã‚“ã ã‚‚ã®ã‚’ Secret ã«ã‚»ãƒƒãƒˆã™ã‚‹
          token: ${{ secrets.GITHUBPAT }}
          ref: master # åŒæœŸã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒ
          path: ./From
      # PR ç”¨ã®ãƒ–ãƒ©ãƒ³ãƒåä½œæˆã¨ Private ãƒªãƒã‚¸ãƒˆãƒªã®ãƒãƒƒã‚·ãƒ¥ã‚’å–å¾—ã™ã‚‹
      - name: create branch name
        id: create_branch_name
        run: |
          cd ../From
          HASH=$(git rev-parse HEAD)
          echo "##[set-output name=hash;]$(echo ${HASH})"
          # echo "##[set-output name=branch;]$(echo sync/${HASH})"
          # ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹åº¦ã« PR ä½œã‚‰ã‚Œã‚‹ã‚ˆã‚Šã‚‚ã€PR ã¯ï¼‘ã¤ã§æ›´æ–°ã•ã‚Œã‚‹æ–¹ãŒã„ã„ã¨æ€ã£ãŸã®ã§åå‰å›ºå®š
          echo "##[set-output name=branch;]$(echo sync/latest)"
      # åŒæœŸç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - uses: actions/setup-python@v2
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Set Python environment variable
        run: echo "LD_LIBRARY_PATH=${{ env.pythonLocation }}/lib" >> $GITHUB_ENV
      # åŒæœŸ
      - name: sync
        # Private -> Public ã¸ã®åŒæœŸã¯ Private å´ã®çŠ¶æ…‹ã‚’å„ªå…ˆã™ã‚‹ã®ã§å…ˆã«å…¨éƒ¨æ¶ˆã™
        # check-publish.py ãŒå…¬é–‹è¨­å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹ã®ã§ã€ãã‚Œã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
        run: |
          rm -rf ./articles/*.md
          python check-publish.py ../From/articles | xargs -I {} cp -f {} ./articles/
      # PR ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä½¿ã£ã¦ PR ä½œæˆ
      # ã“ã‚Œä¾¿åˆ©ï¼ï¼
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3
        with:
          base: master
          branch: ${{ steps.create_branch_name.outputs.branch }}
          title: "Sync from private ${{ steps.create_branch_name.outputs.hash }}"
          body: "sync by https://github.com/${{ env.FROM_REPO_USER }}/${{ env.FROM_REPO_NAME }}/commit/${{ steps.create_branch_name.outputs.hash }}"
          commit-message: "sync by ${{ steps.create_branch_name.outputs.hash }}"
          delete-branch: true
          labels: "sync"
          reviewers: ${{ env.GITHUB_ACTOR }}
```

### check-publish[]().py

`check-publish.py` ã¯ `published: true` ãª Markdown ã‚’æ¤œå‡ºã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚

https://github.com/srz-zumix/Zenn-public/blob/master/check-publish.py

:::details check-publish.py

```python:check-publish.py
#!/usr/bin/env python

import os
import sys
import re

def check(path):
    if os.path.splitext(path)[1] != '.md':
        return False
    with open(path) as f:
        head = f.readline()
        if head.strip() != '---':
            return False
        while True:
            text = f.readline().strip()
            if text == '---':
                break
            if re.match(r'^published:\strue$', text):
                return True
    return False


def check_and_print(path):
    if check(path):
        print(path)


def check_dir(dir):
    for f in os.listdir(dir):
        if f.startswith('.'):
            continue
        path = os.path.join(dir, f)
        if os.path.isdir(path):
            if f in ['articles', 'books']:
                check_dir(path)
        elif os.path.isfile(path):
            check_and_print(path)


def main():
    for path in sys.argv[1:]:
        if os.path.isdir(path):
            check_dir(path)
        elif os.path.isfile(path):
            check_and_print(path)

if __name__ == '__main__':
    main()
```

:::

### Private ãƒªãƒã‚¸ãƒˆãƒªã® push ã‚¤ãƒ™ãƒ³ãƒˆã§ Public ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹

**ã“ã¡ã‚‰ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ Private ãƒªãƒã‚¸ãƒˆãƒªã®æ–¹ã«è¨­å®šã—ã¾ã™**ã€‚

ã€Œ[Github Actions ã§ä»–ã®ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã®å¤‰æ›´é€šçŸ¥ã‚’å—ã‘å–ã£ã¦PRã‚’ä½œæˆã™ã‚‹ Workflow](https://zenn.dev/mizchi/articles/3117b92a834531361fc8)ã€ã‚’å‚è€ƒã«ä½œæˆã—ã¾ã—ãŸã€‚
ï¼ˆâ€» `GITHUB_` ã§å§‹ã¾ã‚‹ Secret ã¯äºˆç´„åã¨ã—ã¦ä½¿ãˆãªããªã£ãŸã£ã½ã„ã®ã§æ°—ã‚’ã¤ã‘ã¦ãã ã•ã„ï¼‰

ï¼ˆPublic ãƒªãƒã‚¸ãƒˆãƒªã®æ–¹ã«ã‚‚åŒæ§˜ã® dispatch.yml ãŒã‚ã‚‹ã®ã§å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚ï¼‰
https://github.com/srz-zumix/Zenn-public/blob/master/.github/workflows/dispatch.yml

```yaml:dispatch.yml
name: 'Dispatch sync'
on:
  push:
    branches:
      - master
    # articles ã¾ãŸã¯ books ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã§æ›´æ–°ãŒã‚ã£ãŸå ´åˆã®ã¿
    paths:
      - 'articles/**'
      - 'books/**'

jobs:
  sync-trigger:
    runs-on: ubuntu-latest
    steps:
      # Public ãƒªãƒã‚¸ãƒˆãƒªã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ã‚‹
      # ï¼ˆpeter-evans ã•ã‚“ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ï¼‰
      - name: dispatch sync
        uses: peter-evans/repository-dispatch@v1
        with:
          repository: srz-zumix/Zenn-public
          token: ${{ secrets.GITHUBPAT }}
          event-type: sync
```

## Public ãƒªãƒã‚¸ãƒˆãƒªã®æ›´æ–°ã‚’ Private ãƒªãƒã‚¸ãƒˆãƒªã«åŒæœŸã™ã‚‹

ä»Šåº¦ã¯é€†ã« Public -> Private ã¸ã®åŒæœŸã‚’è¨­å®šã—ã¾ã™ã€‚
Public ãƒªãƒã‚¸ãƒˆãƒªã§ PR ãªã©ã«å¯¾å¿œã—ãŸå ´åˆã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

`check-publish.py` ã¯å…¨ãåŒã˜ã‚‚ã®ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
`dispatch.yml` ã¨ `sync.yml` ã‚‚ã»ã¼åŒã˜ã‚‚ã®ã‚’ä½¿ã„ã¾ã™ã€‚
Private ãƒªãƒã‚¸ãƒˆãƒªãªã®ã§å®Ÿç‰©ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ãŒã€å·®åˆ†ã ã‘èª¬æ˜ã—ã¾ã™ã€‚

Private -> Public ã®å ´åˆã¯ã€Public å´ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¦ Private ã‚’å„ªå…ˆã—ã¦ã„ã¾ã—ãŸã€‚
Public -> Private ã®å ´åˆã‚‚ã€Private ã‚’å„ªå…ˆã—ãŸã„ã®ã§ä»Šåº¦ã¯ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ã‚’ã—ã¾ã›ã‚“ã€‚
ï¼ˆPrivate å´ã«ã¯æœªå…¬é–‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ãŸã‚ï¼‰

```diff:sync.yml
      - name: sync
        run: |
-         rm -rf ./articles/*.md
+         # rm -rf ./articles/*.md
          python check-publish.py ../From/articles | xargs -I {} cp -f {} ./articles/
```

ã‚ã¨ã¯ã€ãƒªãƒã‚¸ãƒˆãƒªã®å‘ãå…ˆãŒ Public <-> Private ã§å…¥ã‚Œæ›¿ã‚ã‚‹ã ã‘ã§ã™ã€‚

```diff:sync.yml
      FROM_REPO_USER: "srz-zumix"
-     FROM_REPO_NAME: "Zenn"
+     FROM_REPO_NAME: "Zenn-public"
```

```diff:dispatch.yml
      - name: dispatch sync
        uses: peter-evans/repository-dispatch@v1
        with:
-         repository: srz-zumix/Zenn-public
+         repository: srz-zumix/Zenn
          token: ${{ secrets.GITHUBPAT }}
```

## çµæœ

https://github.com/srz-zumix/Zenn-public/pull/12

![PRçµæœ](https://storage.googleapis.com/zenn-user-upload/47zrvqyuar313889i15yy9ay9ume)

## ä»Šå¾Œ

ç¾æ™‚ç‚¹ã§å¯¾å¿œã—ã¦ã‚‹ã®ã¯ articles ã®ã¿ãªã®ã§æœ¬ã‚’æ›¸ã„ãŸã‚‰ books ã«ã‚‚å¯¾å¿œã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚
